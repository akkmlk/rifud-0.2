{% extends 'layout/base_user.html' %}
{% block content %}
<section class="bg-gray-200 p-6">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">

        <!-- Header -->
        <div class="flex justify-between items-start mb-6">
            <div class="text-green-900 font-bold text-3xl "><img src="static\images\logo.png" class="h-9" alt="rifud logo" /></div>
            <div class="text-right">
                <h1 class="text-xl font-bold">INVOICE</h1>
                <p class="text-sm text-gray-500" id="invoiceId">Loading...</p>
            </div>
        </div>

        <!-- Product Info -->
        <div class="flex items-center mb-6">
            <div class="w-16 h-16 bg-gray-200 rounded mr-4 shrink-0">
                <img id="productImage" src="" alt="Product" class="w-full h-full object-cover rounded" style="display: none;">
            </div>
            <div class="grow">
                <div class="text-sm text-green-800 font-semibold">INFO PRODUK</div>
                <div class="font-medium" id="productName">Loading...</div>
            </div>
            <div class="text-center ml-4">
                <div class="text-sm text-green-800 font-semibold">JUMLAH</div>
                <div id="quantity">-</div>
            </div>
            <div class="text-right ml-4">
                <div class="text-sm text-green-800 font-semibold">HARGA</div>
                <div id="price">Rp 0</div>
            </div>
        </div>

        <!-- Dibuat Oleh -->
        <div class="mb-6">
            <div class="text-sm text-green-800 font-semibold mb-1">DIBUAT OLEH</div>
            <div class="font-medium" id="restoName">Loading...</div>
        </div>

        <!-- Untuk -->
        <div class="mb-6">
            <div class="text-sm text-green-800 font-semibold mb-1">UNTUK</div>
            <div class="font-medium" id="buyerName">Loading...</div>
            <div class="text-sm text-gray-600" id="transactionDate">-</div>
            <div class="text-sm text-gray-600" id="paymentMethod">-</div>
        </div>

        <!-- Total & QR Code Box -->
        <div class="bg-green-900 text-white rounded-xl p-4 relative overflow-hidden">
            <!-- Corner decoration -->
            
            
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm text-yellow-300">Total</div>
                <div class="text-xl font-bold" id="totalPrice">Rp 0</div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <p class="text-yellow-300 font-medium">Show this qr <br> to the cashier</p>
                </div>
                <div class="w-20 h-20 bg-white p-2 rounded">
                    <!-- QR Code -->
                    <div id="qrKode" class="w-full h-full flex items-center justify-center">
                        <canvas id="qrCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const transactionId = urlParams.get('id');
        const urlPayment = 'http://127.0.0.1:5000/api/invoice/put-qris/' + transactionId;
        const urlInvoice = 'http://127.0.0.1:5000/api/invoice/' + transactionId;

        async function fetchInvoiceData() {
            try {
                const response = await fetch(urlInvoice);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    const data = result.data;

                    document.getElementById('invoiceId').textContent = "#ORD-" + data.id;

                    if (data.url_foto_fw) {
                        const productImage = document.getElementById('productImage');
                        productImage.src = data.url_foto_fw;
                        productImage.style.display = 'block';
                    }

                    document.getElementById('productName').textContent = data.fw_name || '-';

                    document.getElementById('quantity').textContent = data.qty || 0;

                    const formattedPrice = new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        minimumFractionDigits: 0
                    }).format(data.price || 0);
                    document.getElementById('price').textContent = formattedPrice;

                    document.getElementById('restoName').textContent = data.resto_name || '-';

                    document.getElementById('buyerName').textContent = data.pembeli || '-';

                    const paymentMethodText = data.payment_type === 'qris' ? 'QRIS' : 
                                            data.payment_type === 'cash' ? 'Cash' : 
                                            data.payment_type || '-';
                    document.getElementById('paymentMethod').textContent = `Metode pembayaran: ${paymentMethodText}`;

                    const formattedTotal = new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        minimumFractionDigits: 0
                    }).format(data.price_total || 0);
                    document.getElementById('totalPrice').textContent = formattedTotal;

                    generateQRCode(data.id);

                } else {
                    console.error('Failed to fetch invoice data:', result.message);
                    alert('Gagal memuat data invoice');
                }
            } catch (error) {
                console.error('Error fetching invoice:', error);
                alert('Terjadi kesalahan saat memuat data invoice');
            }
        }

        function generateQRCode(invoiceId) {
            const qrContainer = document.getElementById('qrKode');
            qrContainer.innerHTML = ''; 

            new QRCode(qrContainer, {
                text: `INVOICE-${invoiceId}`,
                width: 76,
                height: 76,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchInvoiceData();

            document.getElementById('qrKode').addEventListener('click', async () => {
            await fetch(urlPayment, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success') {
                        const data = result.data;
                        alert('Berhasil dibayar')
                        window.location.href = '/your-order'

                    } else {
                        alert(result.message)
                        console.log(result.message)
                    }
                })
                .catch(err => {
                    console.error(err)
                })
        })
        });
    </script>
</section>
{% endblock %}